name: SmartHub Release Manager

# Displays the selected target in the GitHub Actions list
run-name: "Build: ${{ github.event_name == 'workflow_dispatch' && inputs.target || 'Smart Hub [Beta] (automatically triggered)' }}"

on:
  # 1. Manual trigger
  workflow_dispatch:
    inputs:
      target:
        description: 'Select build target:'
        required: true
        default: 'Addon [Beta]'
        type: choice
        options:
          - 'Smart Hub [Beta]'
          - 'Smart Hub [Public]'
          - 'Smart Configurator [Windows]'

  # 2. Automatic trigger (Beta only)
  repository_dispatch:
    types: [build-beta-event]

jobs:
  # ----------------------------------------------------------------
  # JOB 1: Home Assistant Add-on (Docker / Linux)
  # Runs for 'Addon' selections or automatic triggers
  # ----------------------------------------------------------------
  build_addon:
    name: Build Smart Hub Addon
    # Run if input contains 'Addon' OR if triggered automatically
    if: |
      contains(inputs.target, 'Addon') || 
      github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Determine Release Mode
        id: config
        run: |
          # Map input name to internal mode (beta/public)
          INPUT="${{ inputs.target }}"
          
          if [[ "$INPUT" == "Addon [Public]" ]]; then
            echo "mode=public" >> $GITHUB_OUTPUT
          else
            echo "mode=beta" >> $GITHUB_OUTPUT
          fi

      # Checkout the correct branch where config.yaml lives
      - name: Checkout Addon Repo
        uses: actions/checkout@v4
        with:
          path: addon
          ref: ${{ steps.config.outputs.mode == 'beta' && 'beta' || 'main' }}

      # Checkout source code from private repo
      - name: Checkout SmartHub Source
        uses: actions/checkout@v4
        with:
          repository: dneprojects/SmartHub
          path: source_temp
          ref: main
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set Environment Variables
        id: target
        run: |
          MODE="${{ steps.config.outputs.mode }}"
          if [[ "$MODE" == "beta" ]]; then
            echo "folder=smart_hub_beta" >> $GITHUB_OUTPUT
            echo "image_name=smart_hub_beta" >> $GITHUB_OUTPUT
          else
            echo "folder=smart_hub" >> $GITHUB_OUTPUT
            echo "image_name=smart_hub" >> $GITHUB_OUTPUT
          fi

      - name: Inject Source Code
        run: |
          TARGET="addon/${{ steps.target.outputs.folder }}/src"
          mkdir -p $TARGET
          cp -R source_temp/* $TARGET/
          rm -rf source_temp

      # Updates version in config.yaml based on const.py
      - name: Sync Version
        id: versioning
        run: |
          python3 -c "
          import re, os
          folder = '${{ steps.target.outputs.folder }}'
          const_path = f'addon/{folder}/src/const.py'
          config_path = f'addon/{folder}/config.yaml'
          
          # Read version from const.py
          with open(const_path, 'r') as f:
              match = re.search(r'VERSION\s*=\s*[\"\']([^\"\']+)[\"\']', f.read())
              version = match.group(1) if match else '0.0.0'
          
          # Update config.yaml
          os.system(f\"sed -i 's/^version:.*/version: {version}/' {config_path}\")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as gh:
              gh.write(f'version={version}\n')
          "

      # Essential for building aarch64 on GitHub runners
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build multi-arch image
      - name: Build Add-on
        uses: home-assistant/builder@2024.03.5
        with:
          args: |
            --amd64 \
            --aarch64 \
            --target /data/addon/${{ steps.target.outputs.folder }} \
            --image "${{ steps.target.outputs.image_name }}" \
            --docker-hub "ghcr.io/${{ github.repository_owner }}" \
            --addon

      - name: Cleanup Source Code
        run: rm -rf addon/${{ steps.target.outputs.folder }}/src

      - name: Commit Config Update
        working-directory: ./addon
        run: |
          git config --global user.name "SmartHub Bot"
          git config --global user.email "bot@smarthub.local"
          
          FILE="${{ steps.target.outputs.folder }}/config.yaml"
          if [[ -n $(git status --porcelain $FILE) ]]; then
            git add $FILE
            git commit -m "Release ${{ steps.config.outputs.mode }}: ${{ steps.versioning.outputs.version }}"
            git push
          else
            echo "No changes to commit."
          fi

  # ----------------------------------------------------------------
  # JOB 2: Smart Configurator (Windows .exe)
  # Runs only if 'Configurator' is selected
  # ----------------------------------------------------------------
  build_windows_exe:
    name: Build Smart Configurator
    if: contains(inputs.target, 'Configurator')
    runs-on: windows-latest
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: dneprojects/SmartHub
          ref: main
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          # Pillow is required for the --splash feature
          pip install Pillow 
          # Install other requirements if file exists
          if (Test-Path requirements.txt) { pip install -r requirements.txt }

      # Extract version from const.py for artifact naming
      - name: Get Version
        id: get_version
        shell: python
        run: |
          import re, os
          try:
              with open('const.py', 'r') as f:
                  content = f.read()
                  match = re.search(r'VERSION\s*=\s*[\"\']([^\"\']+)[\"\']', content)
                  version = match.group(1) if match else '0.0.0'
          except:
              version = '0.0.0'
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as gh:
              gh.write(f'version={version}\n')

      - name: Build with PyInstaller
        run: |
          # Build .exe with icon and splash screen
          pyinstaller --onefile --noconsole -i assets/hbtn.ico --splash assets/smart-configurator.png SmartConfigurator.py
          
      - name: Prepare Release Package
        shell: pwsh
        run: |
          # Create directories (silently)
          New-Item -ItemType Directory -Force -Path release_package | Out-Null
          New-Item -ItemType Directory -Force -Path release_package\web | Out-Null

          # 1. Copy EXE
          if (Test-Path "dist\SmartConfigurator.exe") {
              Copy-Item "dist\SmartConfigurator.exe" -Destination release_package\
          } else {
              Write-Error "Error: 'dist\SmartConfigurator.exe' missing."
              exit 1
          }

          # 2. Copy Config
          if (Test-Path "logging_def.yaml") {
              Copy-Item "logging_def.yaml" -Destination release_package\
          } else {
              Write-Error "Error: 'logging_def.yaml' missing."
              exit 1
          }

          # 3. Copy Web Folder
          if (Test-Path "web") {
              Copy-Item -Recurse -Force "web\*" -Destination release_package\web\
          } else {
              Write-Error "Error: 'web' folder missing."
              exit 1
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SmartConfigurator_v${{ steps.get_version.outputs.version }}
          # Upload the entire folder content
          path: release_package/
